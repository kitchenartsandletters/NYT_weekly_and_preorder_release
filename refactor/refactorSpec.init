<file name=0 path=/Users/gilcalderon/shopify-projects/NYT_weekly_and_preorder_release/refactor/refactorSpec.init>
âœ… NYT Preorder & Weekly Report System â€“ Refactor Specification (refactorSpec.init)

Overview

This system automates the tracking, approval, release, and reporting of preorder books sold via Shopify. It replaces a brittle file- and GitHub-driven system with a robust, database-backed workflow deployed to Railway.

â¸»

ğŸ§± Tech Stack
	â€¢	Platform: Railway (for app deployment)
	â€¢	Database: PostgreSQL (Railway-hosted)
	â€¢	Primary Interfaces:
	â€¢	Slack: Slash commands & modals for approvals and alerts
	â€¢	(Optional in future): Web UI for audit trail, filtering, and history

â¸»

ğŸ“¦ Phase 0: Project Layout & Scaffolding

Directory structure:

refactor/
â”œâ”€â”€ db/
â”‚   â”œâ”€â”€ db.py
â”‚   â””â”€â”€ schema.sql
â”œâ”€â”€ slack/
â”‚   â”œâ”€â”€ commands.md
â”‚   â””â”€â”€ slack_handler.py
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ ingest.py
â”‚   â”œâ”€â”€ nyt_report.py
â”‚   â”œâ”€â”€ presales.py
â”‚   â”œâ”€â”€ readiness.py
â”‚   â”œâ”€â”€ record_cancellation.py
â”‚   â”œâ”€â”€ record_presales.py
â”‚   â”œâ”€â”€ record_refund.py
â”‚   â”œâ”€â”€ record_sales.py
â”‚   â”œâ”€â”€ release.py
â”‚   â”œâ”€â”€ record_preorder.py
â”‚   â”œâ”€â”€ sync_preorders.py
â”‚   â””â”€â”€ utils.py
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ db.py
â”œâ”€â”€ workflows/
â”‚   â””â”€â”€ generate_report.yml
â”œâ”€â”€ .env.example
â”œâ”€â”€ README.md
â”œâ”€â”€ __init__.py
â”œâ”€â”€ main.py
â””â”€â”€ refactorSpec.init

â¸»

ğŸ—ƒï¸ Phase 1: Database Structure

Tables and their purposes:

Table	    Purpose
preorders	All products tagged â€˜preorderâ€™ from Shopify. Core metadata lives here.
presales	Each preorder line item sold (by order_id, ISBN, qty, date).
releases	Approved releases with presale snapshot and inventory.
anomalies	Logged validation errors and data mismatches.
audit_logs	Snapshots of batch jobs, imports, and warnings.
nyt_exports	Tracks which ISBNs were exported in a given weekly NYT report.
sales_log	All regular (non-preorder) sales from Shopify orders (order_id, ISBN, quantity, order date).
refund_log  Tracks individual line-item refund activity to maintain accurate historical sales totals and to reconcile preorder vs regular sales tallies.

Full schema provided in schema.sql (foreign keys, types, timestamps aligned).

â¸»

ğŸ§  Phase 2: Modular Pipeline

Each of the following is a stateless function in /functions and can be called in sequence or individually for debugging or testing:

sync_preorders()        # Pull 'preorder' tagged products from Shopify
record_presales()       # Log order line items to presales via webhook
record_sales()          # Log regular sales from Shopify orders to sales_log via webhook
analyze_readiness()     # Identify preorder titles eligible for release
release_preorder(isbn)  # Unpublish, remove tags, insert into releases
log_anomalies()         # Detect malformed pub_date, tag, or collection state
export_nyt_report()     # Build NYT-compatible CSV using presales + releases


â¸»

ğŸ” Preorder Lifecycle Rules

Preorder (Active)
	â€¢	Tagged with 'preorder'
	â€¢	In Preorder Collection (handle: 'pre-order')
	â€¢	Pub date (metafield or tag) is in the future

Preorder (Historical)
	â€¢	Tagged with 'preorder'
	â€¢	Not in Preorder Collection
	â€¢	Pub date is in the past

Preorder (Anomaly)
	â€¢	Formatting errors in pub_date
	â€¢	Missing or mismatched tags vs. metafield
	â€¢	Structural data issues (e.g. missing ISBN, duplicate release)

Anomalies are logged to anomalies and surfaced via Slack and optional UI.

ğŸ“ Note: The `preorder` tag is retained on all products as a permanent historical marker, even after release. This supports data validation, auditability, and simplifies classification of historical sales.

â¸»

ğŸ“… Phase 3: Weekly NYT Report

Reporting Window:
	â€¢	Sunday â†’ Saturday (inclusive)
	â€¢	Report is generated Monday AM

Inclusion Logic:

a. Released This Week
	â€¢	Books with a pub_date falling within this weekâ€™s window
	â€¢	Include:
	â€¢	ISBN
	â€¢	Presales total (prior to or on release date)

b. Post-Release Sales
	â€¢	For titles released in prior weeks, include only if they sold copies this week
	â€¢	Presales are not counted again
	â€¢	Only net new sales (via Shopify orders)

c. Regular Sales
	â€¢	All non-preorder sales from sales_log within this weekâ€™s window
	â€¢	Include:
		â€¢	ISBN
		â€¢	Units sold

Export Format (CSV):

Column	Purpose
ISBN	Required by NYT
QTY	Total units sold

Only these 2 fields are required. Other fields (title, pub date, etc.) can be optionally retained for internal use or Slack alert context.

â¸»

ğŸ“² Phase 4: Slack Integration

Slash commands:
	â€¢	/preorders list â†’ Titles eligible for release
	â€¢	/preorders approve <ISBN> â†’ Triggers release_preorder()
	â€¢	/preorders anomalies â†’ Lists detected anomalies
	â€¢	/preorders export â†’ Manually triggers NYT report export

Slack is used for approval, alerts, and quick queries. In the future, a Web UI may be layered in.

â¸»

ğŸ“¤ Phase 5: Exports & Archival
	â€¢	Weekly NYT reports saved as artifacts (CSV)
	â€¢	Releases and presales stored in DB
	â€¢	Optional: JSON backups for full audit (/output/)
	â€¢	GitHub commits no longer used for core logic/state

â¸»

ğŸ” Data Consistency Rules
	â€¢	ISBN is the unique key and is enforced across all tables
	â€¢	Preorders must be synced before analyzing or releasing
	â€¢	Presales must reference a valid preorder ISBN
	â€¢	Releases are single eventsâ€”immutable after snapshot
	â€¢	NYT exports are append-only

â¸»

ğŸ“Œ Phase 6: Regular Sales Tracking (New Addition)

Overview:
	â€¢	Introduces new sales_log table for capturing non-preorder sales from Shopify.
	â€¢	Webhook handler now differentiates preorder vs. regular sales.

Database Schema:
CREATE TABLE sales_log (
    id SERIAL PRIMARY KEY,
    isbn VARCHAR(13) NOT NULL,
    order_id TEXT NOT NULL,
    quantity INTEGER NOT NULL,
    order_date TIMESTAMP NOT NULL
);

Functions:
record_sales() â€” To be invoked via order webhooks for all non-preorder sales.

Integration:
	â€¢	Merged into NYT report logic alongside presales and releases.
	â€¢	Required for accurate reporting of non-preorder titles.

Slack/Alerts:
	â€¢	Not directly exposed yet, but may be in future audit or reporting commands.
</file>
